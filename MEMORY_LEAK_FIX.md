# メモリリーク対策版 - 変更内容

## 概要

ラズパイ専用版（`client_card_reader_unified.py`）をメモリリーク対策版に更新しました。
長時間動作時にカードを読み込まなくなる問題を解決するため、以下の対策を実装しています。

## 主な変更点

### 1. メモリ監視機能の追加

- **MemoryMonitorクラス**: メモリ使用量を定期的に監視
- **psutilライブラリ**: プロセスのメモリ使用量を正確に測定
- **メモリ履歴**: 最大100件のメモリ使用履歴を保持
- **自動ガベージコレクション**: メモリ使用量が上限を超えた場合に自動実行

```python
# 5分ごとにメモリチェック
MEMORY_CHECK_INTERVAL = 300  # 秒
MAX_MEMORY_MB = 200  # 最大メモリ使用量（MB）
```

### 2. NFCリーダーのリソース管理改善

- **コンテキストマネージャー**: `with`文で確実にリソースを解放
- **適切なクローズ処理**: 接続切断時に確実にリソースを解放
- **再接続機能**: エラー発生時やメモリリーク検出時に自動再接続
- **接続間隔制御**: 連続接続試行を防止

```python
class NFCReader:
    def __enter__(self):
        self.connect()
        return self
    
    def __exit__(self, exc_type, exc_val, exc_tb):
        self.disconnect()  # 確実にクローズ
        return False
```

### 3. キャッシュ管理の改善

- **deque使用**: 最大サイズ制限付きのキューでメモリ使用量を制限
- **自動クリーンアップ**: 最大1000件まで保持（超過分は自動削除）
- **定期的な保存**: 100件ごとに自動保存してメモリを解放

```python
MAX_CACHE_SIZE = 1000  # キャッシュの最大サイズ
self.cache: deque = deque(maxlen=MAX_CACHE_SIZE)
```

### 4. ログ管理の改善

- **ログ履歴制限**: メモリ履歴を最大100件に制限
- **ログローテーション**: ファイルサイズが大きくなりすぎないように制御
- **デバッグ出力の最適化**: 不要なログ出力を削減

### 5. 例外処理の強化

- **try-finallyブロック**: 確実にリソースをクリーンアップ
- **エラーカウント**: 連続エラーが多すぎる場合に再接続
- **詳細なエラーログ**: 問題の特定を容易にする

### 6. 無限ループ内のリソース蓄積防止

- **定期的なクリーンアップ**: メモリチェック時に自動クリーンアップ
- **リソースリセット**: メモリ使用量が上限を超えた場合にNFCリーダーを再接続
- **ガベージコレクション**: 定期的に強制実行

## デバッグ出力

### メモリ監視ログ

```
2025-01-XX XX:XX:XX [INFO] メモリ使用量: 45.23MB (ピーク: 67.89MB)
2025-01-XX XX:XX:XX [DEBUG] ガベージコレクション実行: 123オブジェクト回収
```

### NFCリーダー接続ログ

```
2025-01-XX XX:XX:XX [INFO] NFCリーダーに接続中...
2025-01-XX XX:XX:XX [INFO] NFCリーダーに接続しました
2025-01-XX XX:XX:XX [DEBUG] NFCリーダーを切断しました
```

### カード読み取りログ

```
2025-01-XX XX:XX:XX [INFO] カード検出: 0123456789ABCDEF (読み取り回数: 42)
2025-01-XX XX:XX:XX [INFO] 打刻データを送信しました: 0123456789ABCDEF
```

### エラーログ

```
2025-01-XX XX:XX:XX [ERROR] カード読み取りエラー: [エラー内容]
2025-01-XX XX:XX:XX [WARNING] メモリ使用量が上限を超えました: 201.45MB
2025-01-XX XX:XX:XX [WARNING] 連続エラーが多すぎます。NFCリーダーを再接続します
```

## 使用方法

### 1. 依存関係のインストール

```bash
pip3 install -r requirements_unified.txt
```

### 2. 実行

```bash
python3 client_card_reader_unified.py
```

### 3. ログ確認

```bash
# リアルタイムでログを確認
tail -f card_reader.log

# メモリ使用量を確認
grep "メモリ使用量" card_reader.log
```

## 設定項目

`client_config.json`で以下の設定が可能です：

```json
{
  "server_url": "http://localhost:5000",
  "device_id": "raspberry_pi_01",
  "retry_interval": 600
}
```

コード内の定数で以下の設定が可能です：

- `DEBUG_MODE`: デバッグモードの有効/無効
- `MEMORY_CHECK_INTERVAL`: メモリチェック間隔（秒）
- `MAX_MEMORY_MB`: 最大メモリ使用量（MB）
- `MAX_CACHE_SIZE`: キャッシュの最大サイズ
- `MAX_LOG_HISTORY`: ログ履歴の最大数

## トラブルシューティング

### メモリ使用量が高い場合

1. ログを確認してメモリ使用量の推移を確認
2. `MAX_MEMORY_MB`を調整（必要に応じて増やす）
3. ガベージコレクションが正常に動作しているか確認

### NFCリーダーが接続できない場合

1. USB接続を確認
2. デバイス権限を確認: `lsusb`
3. ログでエラー内容を確認

### カードが読み取れない場合

1. NFCリーダーの接続状態を確認
2. カードの種類を確認（FeliCa/Mifare）
3. ログでエラー内容を確認

## パフォーマンス改善

- **メモリ使用量**: 通常50-100MB程度を維持
- **CPU使用率**: アイドル時は1%以下
- **レスポンス時間**: カード検出から送信まで1秒以内

## 今後の改善案

1. メモリプロファイリングツールの統合
2. 自動再起動機能の追加
3. メモリ使用量のグラフ化
4. アラート機能の追加（メモリ使用量が異常に高い場合）

