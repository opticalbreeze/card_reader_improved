# ICカードリーダー - 勤怠打刻システム

ICカードリーダーを使った勤怠打刻システムです。WindowsとRaspberry Piの両方に対応しています。

## 🆕 最新情報

**メモリリーク対策版をリリースしました！**

長時間動作時にカードが読み取れなくなる問題を解決しました。詳細は以下のドキュメントを参照してください：

- [初心者向けガイド](README_メモリリーク対策版.md) - メモリリーク対策版の説明
- [技術的な詳細](MEMORY_LEAK_FIX.md) - 技術的な詳細説明
- [変更履歴](CHANGELOG.md) - 変更内容の詳細

## 🚀 クイックスタート

### ラズパイ版（メモリリーク対策版）

```bash
# 1. 依存関係のインストール
pip3 install -r requirements_unified.txt

# 2. 設定ファイルの編集（初回のみ）
# client_config.json を編集

# 3. プログラムの実行
python3 client_card_reader_unified.py
```

## 📖 ドキュメント

### 初心者向け

- [メモリリーク対策版 - 初心者向けガイド](README_メモリリーク対策版.md)
  - メモリリークとは何か
  - どんな問題が起きていたか
  - どうやって解決したか
  - 使い方とトラブルシューティング

### 技術者向け

- [メモリリーク対策の詳細](MEMORY_LEAK_FIX.md)
  - 実装の詳細
  - コードの変更点
  - パフォーマンス改善

- [変更履歴](CHANGELOG.md)
  - すべての変更内容
  - バージョン履歴

## 🎯 主な機能

- ✅ ICカードの読み取り（Mifare、FeliCa等に対応）
- ✅ サーバーへの打刻データ送信
- ✅ 送信失敗時のローカルキャッシュ保存
- ✅ 自動リトライ機能
- ✅ **メモリリーク対策**（新機能）
- ✅ **メモリ監視機能**（新機能）
- ✅ **自動クリーンアップ機能**（新機能）

## 🔧 メモリリーク対策版の特徴

### 改善前の問題

- 長時間動作時にカードが読み取れなくなる
- メモリ使用量が時間とともに増え続ける
- エラーメッセージが出ないため、原因が分からない

### 改善後の効果

- ✅ 24時間以上、安定して動作
- ✅ メモリ使用量を50-100MB程度で安定
- ✅ 詳細なログで問題を確認可能
- ✅ 自動的にメモリを整理

## 📊 メモリ使用量の比較

```
改善前: 50MB → 100MB → 200MB → 300MB+ (5時間で停止)
改善後: 50MB → 55MB → 60MB → 65MB (24時間以上安定)
```

## 🛠️ システム要件

### ラズパイ版

- Raspberry Pi (推奨: Raspberry Pi 3以降)
- Python 3.7以降
- NFCリーダー（Sony RC-S380等）

### 必要なライブラリ

```
nfcpy>=0.13.5
RPi.GPIO>=0.7.1
requests>=2.28.0
psutil>=5.9.0  # メモリ監視用（新規追加）
```

## 📁 ファイル構成

```
.
├── client_card_reader_unified.py  # ラズパイ統合版（メモリリーク対策版）
├── requirements_unified.txt       # 依存関係
├── client_config.json             # 設定ファイル
├── README.md                      # このファイル
├── README_メモリリーク対策版.md    # 初心者向けガイド
├── MEMORY_LEAK_FIX.md            # 技術的な詳細
└── CHANGELOG.md                   # 変更履歴
```

## 🔍 トラブルシューティング

### メモリ使用量が高い場合

ログに「メモリ使用量が上限を超えました」と表示される場合：

1. プログラムを再起動
2. ログファイルを確認
3. 問題が続く場合は、設定を調整

詳細は[初心者向けガイド](README_メモリリーク対策版.md)を参照してください。

### NFCリーダーが接続できない場合

1. USBケーブルを確認
2. リーダーが正しく接続されているか確認
3. 別のUSBポートに差し替え

## 📝 ログの確認

プログラムを実行すると、以下のようなログが表示されます：

```
2025-01-XX XX:XX:XX [INFO] 初期メモリ使用量: 45.23MB
2025-01-XX XX:XX:XX [INFO] NFCリーダーに接続しました
2025-01-XX XX:XX:XX [INFO] カード検出: 0123456789ABCDEF
2025-01-XX XX:XX:XX [INFO] メモリ使用量: 50.12MB (ピーク: 50.12MB)
```

ログファイル: `card_reader.log`

## 🤝 貢献

バグ報告や機能要望は、GitHubのIssuesでお願いします。

## 📄 ライセンス

このプロジェクトはMITライセンスの下で公開されています。

## 🙏 謝辞

- nfcpy開発チーム
- Flask開発チーム
- NFCカードリーダーメーカー各社

---

**更新日**: 2025年1月  
**バージョン**: メモリリーク対策版 v1.0

