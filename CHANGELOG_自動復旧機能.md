# 自動復旧機能の追加 - 変更履歴

## 🔧 問題の原因

1時間ほどでカードが読まなくなる問題の原因：
- NFCリーダーの接続が切れても検知できていない
- 接続状態を定期的にチェックしていない
- エラーが発生しても自動復旧しない
- ハートビート機能がない（動作しているか確認できない）

## ✅ 実装した改善

### 1. ハートビート機能の追加

**機能**: 5分ごとに動作状況をログに出力

**効果**:
- プログラムが動作しているか確認できる
- 問題発生時刻を特定しやすい
- 稼働時間、読み取り回数、エラー回数を記録

**ログ例**:
```
[ハートビート] 動作中 - 稼働時間: 3600秒, 読み取り回数: 42, エラー回数: 0, ループ回数: 72000
```

### 2. NFCリーダーの接続状態チェック

**機能**: 1分ごとに接続状態を確認

**効果**:
- 接続が切れた場合、自動的に検知
- 自動的に再接続を試行
- 接続が切れてもプログラムが停止しない

**処理フロー**:
1. 1分ごとに接続状態をチェック
2. 接続が切れている場合、自動的に再接続
3. 再接続に失敗した場合、5秒後に再試行
4. 2回失敗した場合、エラーログを出力

### 3. 長時間カード検出なしの自動リセット

**機能**: 5分間カードが検出されない場合、接続をリセット

**効果**:
- NFCリーダーが応答しなくなった場合、自動的にリセット
- 接続が不安定な場合でも、自動的に復旧

**処理フロー**:
1. 最後にカードが検出された時刻を記録
2. 5分間カードが検出されない場合、接続をリセット
3. 再接続を試行
4. 成功した場合、検出時刻をリセット

### 4. エラーハンドリングの強化

**改善点**:
- `nfc.clf.CommunicationError`を個別に処理
- エラー発生時の詳細なログ出力
- 連続エラー時の自動再接続
- 再接続失敗時の再試行機能

**エラーログ例**:
```
[ERROR] ループ内エラー (エラー回数: 5, 連続エラー: 3): [エラー内容]
[WARNING] 連続エラーが10回発生しました。NFCリーダーを再接続します
[INFO] NFCリーダーを再接続しました
```

### 5. 詳細なログ出力

**追加されたログ**:
- ハートビート（5分ごと）
- 接続状態チェック（1分ごと）
- 接続リセット時のログ
- 再接続成功/失敗のログ
- エラー発生時の詳細情報

## 📊 改善効果

### 改善前

- 1時間ほどでカードが読めなくなる
- エラーメッセージが出ない
- 原因が特定できない
- 手動で再起動が必要

### 改善後

- 接続が切れても自動的に復旧
- 詳細なログで問題を特定可能
- ハートビートで動作状況を確認可能
- 長時間安定して動作

## 🔍 ログの確認方法

### ハートビートの確認

```bash
grep "ハートビート" card_reader.log
```

### 接続状態の確認

```bash
grep "接続" card_reader.log
```

### エラーの確認

```bash
grep "ERROR" card_reader.log
```

### 再接続の確認

```bash
grep "再接続" card_reader.log
```

## ⚙️ 設定項目

以下の設定を変更できます（`client_card_reader_unified.py`内）：

```python
self.connection_check_interval = 60  # 接続チェック間隔（秒）
self.no_card_detection_timeout = 300  # カードが検出されない場合のタイムアウト（秒）
```

### 推奨設定

- **接続チェック間隔**: 60秒（1分）
  - 短すぎると負荷が高くなる
  - 長すぎると問題検知が遅れる

- **カード検出タイムアウト**: 300秒（5分）
  - 短すぎると頻繁にリセットされる
  - 長すぎると問題検知が遅れる

## 🚀 使用方法

変更は自動的に適用されます。既存のコードを更新するだけです：

```bash
# ラズパイで最新のコードを取得
cd ~/card_reader_improved
git pull origin main

# プログラムを再起動
python3 client_card_reader_unified.py
```

## 📝 注意事項

1. **ログファイルのサイズ**: ハートビート機能により、ログファイルが大きくなる可能性があります。定期的にログローテーションを設定することを推奨します。

2. **再接続の頻度**: 接続が不安定な場合、頻繁に再接続が発生する可能性があります。その場合は、接続チェック間隔を調整してください。

3. **カード検出タイムアウト**: カードを読み取らない時間が長い場合、自動的にリセットされます。これは正常な動作です。

## 🔄 今後の改善案

- [ ] ログローテーション機能の追加
- [ ] 接続状態の統計情報の記録
- [ ] アラート機能の追加（接続が頻繁に切れる場合）
- [ ] Web UIでの状態監視

---

**更新日**: 2025年1月
**バージョン**: 自動復旧機能強化版 v1.1

