# 文字化け原因調査と対策

## 🔍 問題の詳細

「よくわからない記号が出力される」という症状から、以下の原因が考えられます：

### 考えられる原因

1. **制御文字の混入**
   - カードIDに制御文字（0x00-0x1F）が含まれている
   - 改行、タブなどの制御文字が表示される

2. **バイナリデータの混入**
   - `tag.idm`や`tag.identifier`が正しく文字列に変換されていない
   - bytesオブジェクトがそのまま表示されている

3. **特殊文字の混入**
   - 16進数以外の文字（0x7F-0xFF）が含まれている
   - 文字コードの変換ミス

4. **文字コードの不一致**
   - LCDの文字コードテーブルと実際の文字コードが一致していない
   - エンコーディングの問題

## ✅ 実装した対策

### 1. カードIDの検証とクリーンアップ

```python
# 16進数文字列として検証（0-9, A-Fのみ）
if all(c in '0123456789ABCDEF' for c in card_id):
    # 正常
else:
    # 無効な文字を除去
    card_id = ''.join(c for c in card_id if c in '0123456789ABCDEF')
```

### 2. 文字列の型チェックと変換

```python
# bytesオブジェクトの場合、確実に文字列に変換
if isinstance(text, bytes):
    text = text.decode('ascii', errors='replace')
```

### 3. 詳細なデバッグログ

```python
# 無効な文字が見つかった場合、ログに出力
if DEBUG_MODE and invalid_chars:
    logger.warning(f"LCD表示から無効な文字を除去: {invalid_chars} (元の文字列: {repr(text)})")
```

### 4. 最終チェック

```python
# すべての文字が表示可能なASCII文字か確認
for i, char in enumerate(result):
    char_code = ord(char)
    if not (0x20 <= char_code <= 0x7E or char == ' '):
        logger.error(f"LCD表示に無効な文字が含まれています: 位置{i}, 文字コード0x{char_code:02X}")
        result = result[:i] + ' ' + result[i+1:]
```

## 🐛 デバッグ方法

### ログで確認

```bash
# 無効な文字の検出ログ
grep "無効な文字" card_reader.log

# カード検出のログ
grep "カード検出" card_reader.log

# LCD表示のログ
grep "LCD表示" card_reader.log
```

### 実際の文字列を確認

デバッグモードが有効な場合、以下の情報がログに出力されます：

```
[WARNING] LCD表示から無効な文字を除去: ['0x00', '0x1F'] (元の文字列: '0123456789ABCDEF\x00\x1F')
[DEBUG] LCD表示: 'Card Detected    ' / '0123456789ABCDEF' (長さ: 16/16)
```

## 📊 文字コードの確認

### 表示可能なASCII文字

- **0x20-0x7E**: 表示可能なASCII文字
  - 0x20: スペース
  - 0x21-0x7E: 英数字、記号

### 制御文字（表示されない、または記号として表示される）

- **0x00-0x1F**: 制御文字
  - 0x00: NULL（何も表示されない、または記号）
  - 0x01-0x1F: 各種制御文字（記号として表示される可能性）

### 特殊文字（記号として表示される）

- **0x7F-0xFF**: 特殊文字、拡張ASCII
  - 記号として表示される可能性

## 🔧 トラブルシューティング

### 問題1: カードIDに制御文字が含まれている

**症状**: カードIDの一部が記号として表示される

**対処法**: 
- ログで無効な文字を確認
- カードIDの検証処理で自動的に除去される

### 問題2: bytesオブジェクトがそのまま表示されている

**症状**: バイナリデータが記号として表示される

**対処法**:
- 文字列の型チェックと変換処理で自動的に修正される

### 問題3: 16進数以外の文字が含まれている

**症状**: カードIDに予期しない文字が含まれている

**対処法**:
- カードIDの検証処理で自動的に除去される

## 📝 今後の改善案

- [ ] カードIDの検証をより厳密に
- [ ] 文字コードの詳細なログ出力
- [ ] LCDへの送信データの16進数ダンプ

---

**更新日**: 2025年1月
**バージョン**: 文字化け原因調査版 v1.5

