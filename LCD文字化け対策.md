# LCD文字化け対策

## 🔍 問題の原因

LCD（I2C 1602など）は通常、ASCII文字（0x20-0x7E）のみをサポートしています。日本語や特殊文字を表示しようとすると、文字化けが発生します。

## ✅ 実装した対策

### 1. 文字列サニタイズ機能の追加

`sanitize_lcd_text()` 関数を追加して、LCD表示用に文字列をサニタイズします。

**処理内容**:
- ASCII文字（0x20-0x7E）はそのまま表示
- 日本語や特殊文字は空白に変換
- 改行やタブは空白に変換
- 最大長（16文字）に制限
- 空文字列の場合は空白を返す

### 2. LCD更新関数の改善

`update_lcd()` 関数を修正して、すべての文字列をサニタイズしてから表示します。

**改善点**:
- すべての文字列を自動的にサニタイズ
- デバッグログで実際に表示される文字列を確認可能
- エラーハンドリングを強化

## 📝 使用例

### 修正前

```python
# 日本語が含まれると文字化け
self.update_lcd("カード検出", "0123456789ABCDEF")
```

### 修正後

```python
# 自動的にASCII互換文字に変換
self.update_lcd("Card Detected", "0123456789ABCDEF")
# または日本語でも自動的に処理される
self.update_lcd("カード検出", "0123456789ABCDEF")
# → "Card Detected" のように表示される（日本語部分は空白に変換）
```

## 🔧 コードの動作

### sanitize_lcd_text() 関数

```python
def sanitize_lcd_text(self, text: str, max_length: int = 16) -> str:
    """LCD表示用に文字列をサニタイズ（ASCII互換文字のみ）"""
    # ASCII文字（0x20-0x7E）はそのまま
    # その他の文字は空白に変換
    # 最大長に制限
    return sanitized_text
```

### update_lcd() 関数

```python
def update_lcd(self, line1: str, line2: str):
    """LCDを更新（文字化け対策版）"""
    # 文字列をサニタイズ
    safe_line1 = self.sanitize_lcd_text(line1, 16)
    safe_line2 = self.sanitize_lcd_text(line2, 16)
    
    # LCDに表示
    self.lcd.display(safe_line1, safe_line2)
```

## 📊 表示される文字列

### 正常に表示される文字

- 英数字: `A-Z`, `a-z`, `0-9`
- 記号: `!`, `@`, `#`, `$`, `%`, `^`, `&`, `*`, `(`, `)`, `-`, `_`, `=`, `+`, `[`, `]`, `{`, `}`, `|`, `\`, `;`, `:`, `'`, `"`, `,`, `.`, `<`, `>`, `/`, `?`, `~`, `` ` ``
- 空白: ` ` (スペース)

### 文字化けする文字（自動的に空白に変換）

- 日本語: `あ`, `い`, `う`, `え`, `お` など
- 特殊文字: `©`, `®`, `™` など
- 絵文字: `😀`, `👍` など

## 🐛 デバッグ方法

### ログで確認

デバッグモードが有効な場合、LCDに表示される文字列がログに出力されます：

```
[DEBUG] LCD表示: 'Card Reader' / 'Ready'
[DEBUG] LCD表示: 'Card Detected' / '0123456789ABCDEF'
```

### ログの確認方法

```bash
# デバッグログを確認
grep "LCD表示" card_reader.log
```

## ⚙️ 設定

### 最大文字数の変更

`sanitize_lcd_text()` 関数の `max_length` パラメータを変更できます：

```python
# デフォルト: 16文字
safe_line1 = self.sanitize_lcd_text(line1, 16)

# 20文字に変更（LCDが20文字対応の場合）
safe_line1 = self.sanitize_lcd_text(line1, 20)
```

## 🔄 今後の改善案

- [ ] カスタム文字マッピング（特定の日本語文字をASCII文字に変換）
- [ ] スクロール表示機能（長い文字列をスクロール表示）
- [ ] 複数行表示の最適化

## 📝 注意事項

1. **ASCII文字のみ**: LCDはASCII文字のみをサポートしています。日本語を表示したい場合は、事前にASCII文字に変換してください。

2. **文字列の長さ**: 最大16文字（またはLCDの表示幅）に制限されます。長い文字列は自動的に切り詰められます。

3. **空白の処理**: 日本語や特殊文字は空白に変換されます。意図的に空白を表示したい場合は、スペース文字（` `）を使用してください。

---

**更新日**: 2025年1月
**バージョン**: LCD文字化け対策版 v1.2

