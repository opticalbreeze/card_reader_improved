# PC/SCã‚«ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼è‡ªå‹•èµ·å‹•æ™‚ã‚¨ãƒ©ãƒ¼åˆ†æ

## ğŸ” å•é¡Œã®æ¦‚è¦

**ç—‡çŠ¶**: PC/SCã‚«ãƒ¼ãƒ‰ãƒªãƒ¼ãƒ€ãƒ¼ãŒè‡ªå‹•èµ·å‹•æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦èª­ã¿å–ã‚Šã§ããªã„  
**çŠ¶æ³**: æ‰‹å‹•èµ·å‹•ï¼ˆ`bash start_pi.sh`ï¼‰ã§ã¯å•é¡Œãªãå‹•ä½œã™ã‚‹

---

## ğŸ“Š æ‰‹å‹•èµ·å‹•ã¨è‡ªå‹•èµ·å‹•ã®é•ã„

### æ‰‹å‹•èµ·å‹•æ™‚ã®ç’°å¢ƒ

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã—ãŸçŠ¶æ…‹ã§å®Ÿè¡Œ
$ bash start_pi.sh
```

**ç’°å¢ƒã®ç‰¹å¾´**:
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æŒã£ã¦ã„ã‚‹
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚°ãƒ«ãƒ¼ãƒ—ï¼ˆpcscdã‚°ãƒ«ãƒ¼ãƒ—ã‚’å«ã‚€ï¼‰ãŒæœ‰åŠ¹
- âœ… ã‚·ã‚§ãƒ«ã®ç’°å¢ƒå¤‰æ•°ãŒç¶™æ‰¿ã•ã‚Œã‚‹
- âœ… PC/SCã‚½ã‚±ãƒƒãƒˆï¼ˆ/var/run/pcscd/pcscd.commï¼‰ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒã‚ã‚‹

### è‡ªå‹•èµ·å‹•æ™‚ã®ç’°å¢ƒ

```ini
# systemdã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®Ÿè¡Œ
[Service]
User=raspberry
Group=pcscd
ExecStart=/bin/bash /home/raspberry/Desktop/attendance/card_reader_improved/start_pi.sh
```

**ç’°å¢ƒã®ç‰¹å¾´**:
- âš ï¸ ãƒ­ã‚°ã‚¤ãƒ³ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„ï¼ˆsystemdã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®Ÿè¡Œï¼‰
- âš ï¸ ã‚°ãƒ«ãƒ¼ãƒ—ã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ï¼ˆå†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ï¼‰
- âœ… ç’°å¢ƒå¤‰æ•°ã¯ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã§æ˜ç¤ºçš„ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
- âš ï¸ PC/SCã‚½ã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®å•é¡Œã®å¯èƒ½æ€§

---

## ğŸ” æ¨å¯Ÿã•ã‚Œã‚‹åŸå› 

### 1. **PC/SCã‚½ã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®å•é¡Œ** â­ æœ€ã‚‚å¯èƒ½æ€§ãŒé«˜ã„

**å•é¡Œç‚¹**:
- PC/SCã‚½ã‚±ãƒƒãƒˆ `/var/run/pcscd/pcscd.comm` ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§
- `Group=pcscd` ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒpcscdã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã—ã¦ã„ãªã„ã€ã¾ãŸã¯å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦

**ç¢ºèªæ–¹æ³•**:
```bash
# ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚’ç¢ºèª
ls -l /var/run/pcscd/pcscd.comm

# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒpcscdã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã—ã¦ã„ã‚‹ã‹ç¢ºèª
groups raspberry | grep pcscd

# ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè¡Œæ™‚ã®ãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒã‚’ç¢ºèª
sudo systemctl status attendance-client-fixed.service
sudo journalctl -u attendance-client-fixed.service -n 100
```

**è§£æ±ºç­–**:
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’pcscdã‚°ãƒ«ãƒ¼ãƒ—ã«è¿½åŠ ï¼ˆæ—¢ã«å®Ÿæ–½æ¸ˆã¿ã®å¯èƒ½æ€§ï¼‰
2. **å†ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯å†èµ·å‹•**ï¼ˆã‚°ãƒ«ãƒ¼ãƒ—ã®å¤‰æ›´ã‚’åæ˜ ï¼‰
3. ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™ã‚’ç¢ºèª

### 2. **PC/SCã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œ**

**å•é¡Œç‚¹**:
- `ExecStartPre`ã§pcscdã‚µãƒ¼ãƒ“ã‚¹ã®èµ·å‹•ã‚’å¾…ã£ã¦ã„ã‚‹ãŒã€ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹å‰ã«å®Ÿè¡Œã•ã‚Œã¦ã„ã‚‹å¯èƒ½æ€§

**ç¾åœ¨ã®è¨­å®š**:
```ini
ExecStartPre=/bin/sleep 5
ExecStartPre=/bin/bash -c 'until systemctl is-active --quiet pcscd; do sleep 1; done'
```

**å•é¡Œ**: `systemctl is-active`ã¯ã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ãŸã“ã¨ã‚’ç¤ºã™ãŒã€ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã¾ã§å¾…ã£ã¦ã„ãªã„

**è§£æ±ºç­–**: ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ã‚’ç¢ºèªã™ã‚‹å¾…æ©Ÿå‡¦ç†ã‚’è¿½åŠ 

### 3. **ç’°å¢ƒå¤‰æ•°ã®å•é¡Œ**

**ç¾åœ¨ã®è¨­å®š**:
```ini
Environment="PCSCLITE_CSOCK_NAME=/var/run/pcscd/pcscd.comm"
```

**å•é¡Œç‚¹**:
- ç’°å¢ƒå¤‰æ•°ã¯è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŒã€pyscardãƒ©ã‚¤ãƒ–ãƒ©ãƒªãŒæ­£ã—ãèªè­˜ã—ã¦ã„ãªã„å¯èƒ½æ€§
- ä»®æƒ³ç’°å¢ƒå†…ã®pyscardãŒç’°å¢ƒå¤‰æ•°ã‚’æ­£ã—ãèª­ã¿å–ã‚Œã¦ã„ãªã„å¯èƒ½æ€§

### 4. **ä»®æƒ³ç’°å¢ƒã®å•é¡Œ**

**å•é¡Œç‚¹**:
- ä»®æƒ³ç’°å¢ƒå†…ã®pyscardãŒæ­£ã—ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„
- ä»®æƒ³ç’°å¢ƒã®ãƒ‘ã‚¹ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ãªã„

**ç¢ºèªæ–¹æ³•**:
```bash
# ä»®æƒ³ç’°å¢ƒå†…ã§pyscardãŒæ­£ã—ãã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
source venv/bin/activate
python3 -c "from smartcard.System import readers; print(readers())"
```

---

## ğŸ”§ æ¨å¥¨ã•ã‚Œã‚‹ä¿®æ­£

### ä¿®æ­£1: ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªã‚’è¿½åŠ 

`attendance-client-fixed.service`ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```ini
ExecStartPre=/bin/sleep 5
ExecStartPre=/bin/bash -c 'until systemctl is-active --quiet pcscd; do sleep 1; done'
ExecStartPre=/bin/bash -c 'until [ -S /var/run/pcscd/pcscd.comm ]; do sleep 1; done'
```

**ç†ç”±**: PC/SCã‚µãƒ¼ãƒ“ã‚¹ãŒèµ·å‹•ã—ã¦ã‚‚ã€ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã‚‹ã¾ã§ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹

### ä¿®æ­£2: ã‚°ãƒ«ãƒ¼ãƒ—ã®ç¢ºèªã¨è­¦å‘Š

`start_pi.sh`ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```bash
# PC/SCã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®ç¢ºèª
if ! groups | grep -q '\bpcscd\b'; then
    echo "[è­¦å‘Š] ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒpcscdã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã—ã¦ã„ã¾ã›ã‚“"
    echo "[è­¦å‘Š] ã‚°ãƒ«ãƒ¼ãƒ—ã®å¤‰æ›´ã‚’åæ˜ ã™ã‚‹ã«ã¯ã€å†ãƒ­ã‚°ã‚¤ãƒ³ã¾ãŸã¯å†èµ·å‹•ãŒå¿…è¦ã§ã™"
    echo "[è­¦å‘Š] å®Ÿè¡Œ: sudo usermod -a -G pcscd $USER"
fi
```

### ä¿®æ­£3: PC/SCæ¥ç¶šãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 

`start_pi.sh`ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```bash
# PC/SCæ¥ç¶šãƒ†ã‚¹ãƒˆ
echo "[3.5/4] PC/SCæ¥ç¶šãƒ†ã‚¹ãƒˆä¸­..."
if python3 -c "from smartcard.System import readers; readers()" 2>/dev/null; then
    echo "  PC/SCæ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ"
else
    echo "  [è­¦å‘Š] PC/SCæ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•— - æ¨©é™ã®å•é¡Œã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
    echo "  [å¯¾å‡¦] sudo usermod -a -G pcscd $USER ã‚’å®Ÿè¡Œã—ã¦å†ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"
fi
```

---

## ğŸ“ ç¢ºèªã™ã¹ããƒã‚¤ãƒ³ãƒˆ

### 1. ãƒ­ã‚°ã®ç¢ºèª

```bash
# ã‚µãƒ¼ãƒ“ã‚¹ãƒ­ã‚°ã‚’ç¢ºèª
sudo journalctl -u attendance-client-fixed.service -n 100 --no-pager

# PC/SCé–¢é€£ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¤œç´¢
sudo journalctl -u attendance-client-fixed.service | grep -i "pcsc\|smartcard\|permission\|access"
```

### 2. æ¨©é™ã®ç¢ºèª

```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒpcscdã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã—ã¦ã„ã‚‹ã‹
groups raspberry | grep pcscd

# ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®æ¨©é™
ls -l /var/run/pcscd/pcscd.comm

# ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè¡Œæ™‚ã®ãƒ—ãƒ­ã‚»ã‚¹ç’°å¢ƒ
sudo systemctl show attendance-client-fixed.service | grep -i group
```

### 3. æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

```bash
# ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
sudo systemctl stop attendance-client-fixed.service

# æ‰‹å‹•ã§start_pi.shã‚’å®Ÿè¡Œï¼ˆã‚µãƒ¼ãƒ“ã‚¹ã¨åŒã˜ç’°å¢ƒã‚’å†ç¾ï¼‰
sudo -u raspberry -g pcscd bash start_pi.sh
```

---

## ğŸ¯ æœ€ã‚‚å¯èƒ½æ€§ã®é«˜ã„åŸå› 

**PC/SCã‚½ã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®å•é¡Œ**

ç†ç”±ï¼š
1. æ‰‹å‹•èµ·å‹•ã§ã¯å‹•ä½œã™ã‚‹ â†’ ã‚³ãƒ¼ãƒ‰è‡ªä½“ã¯å•é¡Œãªã„
2. è‡ªå‹•èµ·å‹•ã§ã¯ã‚¨ãƒ©ãƒ¼ â†’ ç’°å¢ƒã®é•ã„ãŒåŸå› 
3. `Group=pcscd`ã¯è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒpcscdã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã—ã¦ã„ãªã„ã€ã¾ãŸã¯å†ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦

**ç¢ºèªæ–¹æ³•**:
```bash
# ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒpcscdã‚°ãƒ«ãƒ¼ãƒ—ã«æ‰€å±ã—ã¦ã„ã‚‹ã‹ç¢ºèª
groups raspberry

# æ‰€å±ã—ã¦ã„ãªã„å ´åˆ
sudo usermod -a -G pcscd raspberry

# å†èµ·å‹•ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—ã®å¤‰æ›´ã‚’åæ˜ 
sudo reboot
```

---

## âœ… è‡ªå‹•èµ·å‹•ã¯start_pi.shã«ä¾å­˜ã—ã¦ã„ã‚‹ã‹ï¼Ÿ

**ç­”ãˆ: ã¯ã„ã€ä¾å­˜ã—ã¦ã„ã¾ã™**

```ini
ExecStart=/bin/bash /home/raspberry/Desktop/attendance/card_reader_improved/start_pi.sh
```

è‡ªå‹•èµ·å‹•ã¯`start_pi.sh`ã‚’çµŒç”±ã—ã¦`pi_client.py`ã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚

**å•é¡Œç‚¹**:
- `start_pi.sh`å†…ã§ä»®æƒ³ç’°å¢ƒã‚’æœ‰åŠ¹åŒ–ã—ã¦ã„ã‚‹ãŒã€ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚‚ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¦ã„ã‚‹
- äºŒé‡ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹ãŒã€å•é¡Œã¯ãªã„
- **é‡è¦ãªã®ã¯ã€PC/SCã‚½ã‚±ãƒƒãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™**

---

## ğŸ”§ å³åº§ã«è©¦ã›ã‚‹å¯¾å‡¦æ³•

### æ–¹æ³•1: å†èµ·å‹•ã—ã¦ã‚°ãƒ«ãƒ¼ãƒ—ã®å¤‰æ›´ã‚’åæ˜ 

```bash
sudo usermod -a -G pcscd raspberry
sudo reboot
```

### æ–¹æ³•2: ã‚µãƒ¼ãƒ“ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚½ã‚±ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®å¾…æ©Ÿã‚’è¿½åŠ 

`attendance-client-fixed.service`ã®`ExecStartPre`ã«ä»¥ä¸‹ã‚’è¿½åŠ ï¼š

```ini
ExecStartPre=/bin/bash -c 'until [ -S /var/run/pcscd/pcscd.comm ]; do sleep 1; done'
```

### æ–¹æ³•3: ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦å…·ä½“çš„ãªã‚¨ãƒ©ãƒ¼ã‚’ç‰¹å®š

```bash
sudo journalctl -u attendance-client-fixed.service -f
```

è‡ªå‹•èµ·å‹•æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç¢ºèªã—ã¦ã€å…·ä½“çš„ãªåŸå› ã‚’ç‰¹å®šã™ã‚‹ã€‚

